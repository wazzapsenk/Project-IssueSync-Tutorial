# Project IssueSync Tutorial

This repository is an **educational example** showing how to integrate a  
**Google Sheets → GitHub Issues** synchronization feature into *any* project,  
now including automatic **Assignee** support.

You can follow these steps to:

1. Prepare your local environment (Node.js, npm, etc.).  
2. Create a Google Cloud Service Account and share your Sheet.  
3. Understand every file in the `IssueSync/` folder.  
4. Configure GitHub Actions so the sync script runs on a cron schedule or manually.  
5. Test locally and in GitHub Actions.  
6. See common pitfalls and how to fix them.  


---

## 1. Why IssueSync with Assignee Support Matters

If you store your team’s bug/issue list in a Google Sheet but want to take advantage of GitHub Issues for collaboration, notifications, labels, and assignment tracking, it makes sense to automate:

- **Google Sheets → GitHub**:  
  Whenever a new row appears in the Sheet (with “Issue Number” blank), open a GitHub Issue, assign it to a specific user (based on the “Assignee” column, or default), and write the new issue number back into the Sheet.  
- **Google Sheets “Status” updates → GitHub**:  
  If someone marks “Status” as “Closed” in the Sheet, this script will automatically close the corresponding GitHub Issue.  
- **Google Sheets “Title” or “Description” changes → GitHub**:  
  If you edit the title or description in the Sheet, it will be updated in the GitHub Issue as well.  
- **Labels based on “Priority”**:  
  You can use a “Priority” column (e.g. High/Medium/Low). The script will automatically add a label like `priority:high` or `priority:low` when creating or updating an issue.  
- **Automatic or Manual Assignee**:  
  You can add an “Assignee” column to the Sheet. If that column is filled with a GitHub username, the new Issue will be assigned to that user. If it’s blank, a `DEFAULT_ASSIGNEE` (defined in `.env` or GitHub Secrets) will be used. If both are blank, the Issue remains unassigned.

With everything in **any** project synced this way, your team can continue using Google Sheets for quick edits, but also have all bugs show up in GitHub Issues with proper assignments and labels.

---

## 2. Repo Layout

<pre><code>
Project-IssueSync-Tutorial/
├── .github/
│   └── workflows/
│       └── sync-issues.yml
├── IssueSync/
│   ├── .gitignore
│   ├── package.json
│   ├── package-lock.json    (auto-generated by npm)
│   ├── .env.example
│   └── sync-issues.js
└── README.md
</code></pre>



1. **`.github/workflows/sync-issues.yml`** - Defines a GitHub Actions workflow.  
   - Runs on a schedule (cron) or allows a manual trigger.  
   - Checks out your repo, installs Node.js, sets environment variables from GitHub Secrets, then runs the sync script.

2. **`IssueSync/` directory** - **`.gitignore`** ```
     node_modules/
     .env
     ```
     Prevents your local Node modules and `.env` from being committed.

   - **`package.json`** ```jsonc
     {
       "name": "issuesync",
       "version": "1.0.0",
       "description": "Sync Google Sheets with GitHub Issues (with Assignee support)",
       "main": "sync-issues.js",
       "type": "module",
       "scripts": {
         "sync": "node sync-issues.js"
       },
       "keywords": [
         "google-sheets",
         "github-issues",
         "sync",
         "nodejs",
         "octokit",
         "assignee"
       ],
       "author": "Your Name <you@example.com>",
       "license": "MIT",
       "dependencies": {
         "dotenv": "^16.0.0",
         "googleapis": "^105.0.0",
         "@octokit/rest": "^19.0.0"
       }
     }
     ```

     - `"type": "module"` means this is an ES Module–based project (so we can `import ... from ...`).  
     - The `"sync"` script lets you run `npm run sync` locally to test the script.

   - **`.env.example`** ```dotenv
     # Copy this file to ".env" and fill in your own values.
     # Do NOT commit your real .env file.

     GCP_SHEETS_CREDENTIALS={"type":"service_account","project_id":"your-project-id","private_key_id":"abcdef123456","private_key":"-----BEGIN PRIVATE KEY-----\nYOUR_PRIVATE_KEY_CONTENT\n-----END PRIVATE KEY-----\n","client_email":"service-account@your-project-id.iam.gserviceaccount.com","client_id":"1234567890","auth_uri":"[https://accounts.google.com/o/oauth2/auth](https://accounts.google.com/o/oauth2/auth)","token_uri":"[https://oauth2.googleapis.com/token](https://oauth2.googleapis.com/token)","auth_provider_x509_cert_url":"[https://www.googleapis.com/oauth2/v1/certs](https://www.googleapis.com/oauth2/v1/certs)","client_x509_cert_url":"[https://www.googleapis.com/](https://www.googleapis.com/)..."}

     GSHEET_ID=1AbCdEfGhIJKLmnOpQRstUVwxyz1234567890
     SHEET_NAME=Sheet1

     REPO_OWNER=your-github-username
     REPO_NAME=YourProjectName

     GITHUB_TOKEN=ghp_your_personal_access_token_here

     # Optional default assignee if the Assignee column in Sheet is blank:
     DEFAULT_ASSIGNEE=your-github-username
     ```

     - Copy this to `IssueSync/.env` and replace each placeholder with your actual values.  
     - `GCP_SHEETS_CREDENTIALS` is the JSON text from a Google Cloud Service Account (all on one line).  
     - `GSHEET_ID` is the ID portion of your Google Sheet’s URL (the long string between `/d/` and `/edit`).  
     - `SHEET_NAME` is the tab name in your sheet (e.g. `Sheet1`).  
     - `REPO_OWNER` + `REPO_NAME` point to the GitHub repository where issues will be created/updated.  
     - `GITHUB_TOKEN` must have at least `repo` scope so Octokit can open/close/update issues.  
     - `DEFAULT_ASSIGNEE` is optional. If the Sheet’s “Assignee” column is blank, this user ID will be used.

   - **`sync-issues.js`** 
   ```js
     // IssueSync/sync-issues.js
     // ───────────────────────────
     // ES Module format. “Assignee” support added.
     // Syncs Google Sheets with GitHub Issues.

     import { google } from 'googleapis';
     import { Octokit } from '@octokit/rest';
     import dotenv from 'dotenv';

     // Load environment variables from .env file
     dotenv.config();

     (async () => {
       try {
         // 1) Read environment variables
         const sheetsCredentials = JSON.parse(process.env.GCP_SHEETS_CREDENTIALS);
         const spreadsheetId = process.env.GSHEET_ID;
         const sheetName = process.env.SHEET_NAME || 'Sheet1';
         const githubToken = process.env.GITHUB_TOKEN;
         const repoOwner = process.env.REPO_OWNER;
         const repoName = process.env.REPO_NAME;
         const defaultAssignee = process.env.DEFAULT_ASSIGNEE || '';

         // 2) Prepare Google Sheets API client
         const auth = new google.auth.JWT(
           sheetsCredentials.client_email,
           null,
           sheetsCredentials.private_key,
           ['[https://www.googleapis.com/auth/spreadsheets](https://www.googleapis.com/auth/spreadsheets)']
         );
         const sheetsApi = google.sheets({ version: 'v4', auth });

         // 3) Prepare GitHub API client (Octokit)
         const octokit = new Octokit({ auth: githubToken });

         // 4) Fetch A:G range from Google Sheet (including Assignee column)
         const getResponse = await sheetsApi.spreadsheets.values.get({
           spreadsheetId,
           range: `${sheetName}!A:G`,
         });

         const rows = getResponse.data.values;
         if (!rows || rows.length === 0) {
           console.log('No data found in the Sheet.');
           return;
         }

         const dataRows = rows.slice(1); // Skip header row

         // 5) Prepare to record newly created issue numbers
         const updatedIssueNumbers = [];

         // 6) Loop through each data row
         for (let i = 0; i < dataRows.length; i++) {
           const row = dataRows[i];
           const id = row[0];
           const title = row[1];
           const description = row[2];
           const priority = row[3] || '';
           const status = row[4] || 'Open';
           let issueNumber = row[5] ? parseInt(row[5], 10) : null;
           const sheetAssignee = row[6] ? row[6].trim() : '';

           if (!issueNumber) {
             // a) If “Issue Number” is empty → create a new GitHub Issue
             const bodyText = `**ID:** ${id}\n**Priority:** ${priority}\n\n${description}`;

             // Determine assignee: sheet value or default
             let assigneesArray = [];
             if (sheetAssignee) {
               assigneesArray = [sheetAssignee];
             } else if (defaultAssignee) {
               assigneesArray = [defaultAssignee];
             }

             const createResponse = await octokit.issues.create({
               owner: repoOwner,
               repo: repoName,
               title: title,
               body: bodyText,
               labels: priority
                 ? [`priority:${priority.toLowerCase()}`]
                 : [],
               assignees: assigneesArray,
             });

             issueNumber = createResponse.data.number;
             console.log(
               `Created new issue: #${issueNumber} — ${title} (assigned to: ${assigneesArray.join(', ') || 'none'})`
             );

             updatedIssueNumbers.push({ rowIndex: i + 1, issueNumber });
           } else {
             // b) If “Issue Number” already exists → fetch and update the existing Issue
             const { data: existingIssue } = await octokit.issues.get({
               owner: repoOwner,
               repo: repoName,
               issue_number: issueNumber,
             });

             // 1) Update state if needed
             const ghState = existingIssue.state; // 'open' or 'closed'
             const sheetStatus = status.toLowerCase() === 'closed' ? 'closed' : 'open';
             if (ghState !== sheetStatus) {
               await octokit.issues.update({
                 owner: repoOwner,
                 repo: repoName,
                 issue_number: issueNumber,
                 state: sheetStatus,
               });
               console.log(`Updated issue #${issueNumber} state to ${sheetStatus}`);
             }

             // 2) Update title or description if changed
             if (
               existingIssue.title !== title ||
               !existingIssue.body.includes(description)
             ) {
               const newBody = `**ID:** ${id}\n**Priority:** ${priority}\n\n${description}`;
               await octokit.issues.update({
                 owner: repoOwner,
                 repo: repoName,
                 issue_number: issueNumber,
                 title: title,
                 body: newBody,
               });
               console.log(`Updated issue #${issueNumber} content.`);
             }

             // 3) Update assignee if needed
             const existingAssignees = existingIssue.assignees.map((u) => u.login);
             let targetAssignee = '';
             if (sheetAssignee) {
               targetAssignee = sheetAssignee;
             } else if (defaultAssignee) {
               targetAssignee = defaultAssignee;
             }
             // If current assignee differs from target, update
             if (
               (targetAssignee && !existingAssignees.includes(targetAssignee)) ||
               (!targetAssignee && existingAssignees.length > 0)
             ) {
               await octokit.issues.update({
                 owner: repoOwner,
                 repo: repoName,
                 issue_number: issueNumber,
                 assignees: targetAssignee ? [targetAssignee] : [],
               });
               console.log(
                 `Updated issue #${issueNumber} assignee to: ${targetAssignee || 'none'}`
               );
             }
           }
         }

         // 7) Write any newly created issue numbers back to the Sheet (column F)
         if (updatedIssueNumbers.length > 0) {
           const updates = updatedIssueNumbers.map((item) => {
             const sheetRow = item.rowIndex + 1; // Sheet rows are 1-based
             return {
               range: `${sheetName}!F${sheetRow}`,
               values: [[item.issueNumber.toString()]],
             };
           });

           await sheetsApi.spreadsheets.values.batchUpdate({
             spreadsheetId,
             requestBody: {
               valueInputOption: 'RAW',
               data: updates,
             },
           });
           console.log('Wrote new issue numbers back to the Sheet.');
         }
         console.log('Sync process completed successfully.');
       } catch (error) {
         console.error('Error occurred:', error);
         process.exit(1);
       }
     })();
     ```

